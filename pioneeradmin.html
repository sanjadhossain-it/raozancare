<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pioneer Admin Panel</title>
    <link rel="icon" type="image/x-icon" href="https://i.ibb.co/Ndrx7JS9/pionnerlogo.webp">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: url('https://images.unsplash.com/photo-1519494026892-80bbd2d6fd0d?auto=format&fit=crop&w=1920&q=80') no-repeat center center fixed;
            background-size: cover;
            color: #1e293b;
        }

        .glass {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .input-field {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e2e8f0;
            padding: 0.8rem 1.2rem;
            border-radius: 14px;
            width: 100%;
            outline: none;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .input-field:focus {
            border-color: #3b82f6;
            background: #ffffff;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        .cat-chip {
            cursor: pointer;
            padding: 10px 6px;
            border-radius: 12px;
            border: 1.5px solid #e2e8f0;
            background: rgba(255, 255, 255, 0.5);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            font-size: 0.65rem;
            font-weight: 700;
            color: #64748b;
        }

        .cat-chip.selected {
            border-color: #3b82f6;
            background: #eff6ff;
            color: #2563eb;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        #adminPanel { display: none; }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .progress-container {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: #3b82f6;
            width: 0%;
            transition: width 0.4s ease;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>

<body class="min-h-screen overflow-x-hidden">

    <div id="timeoutWarning" class="fixed top-5 left-1/2 -translate-x-1/2 z-[5000] bg-orange-500 text-white px-6 py-3 rounded-2xl shadow-2xl font-bold hidden">
        Session expiring soon due to inactivity...
    </div>

    <div id="deleteModal" class="fixed inset-0 z-[3000] flex items-center justify-center bg-slate-900/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="glass p-8 rounded-[32px] w-full max-w-sm shadow-2xl mx-4 border border-white/40 transform scale-95 transition-transform duration-300" id="deleteModalContent">
            <div class="text-center">
                <div class="w-20 h-20 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-6">
                    <span class="text-4xl">‚ö†Ô∏è</span>
                </div>
                <h3 class="text-2xl font-extrabold text-slate-800 mb-2">Confirm Delete</h3>
                <p class="text-slate-500 text-sm mb-8">Are you sure you want to permanently remove this record?</p>
                <div class="flex gap-3">
                    <button onclick="closeDeleteModal()" class="flex-1 py-4 rounded-2xl font-bold text-slate-500 hover:bg-white transition-all active:scale-95">CANCEL</button>
                    <button id="confirmDeleteBtn" class="flex-1 py-4 bg-red-500 text-white rounded-2xl font-bold hover:bg-red-600 shadow-lg shadow-red-200 transition-all active:scale-95">DELETE</button>
                </div>
            </div>
        </div>
    </div>

    <div id="loginGate" class="fixed inset-0 z-[1000] flex items-center justify-center bg-slate-900/60 backdrop-blur-2xl">
        <div class="glass p-10 rounded-[40px] w-full max-w-md shadow-2xl mx-4 border border-white/20">
            <div class="text-center mb-10">
                <img src="https://i.ibb.co/Ndrx7JS9/pionnerlogo.webp" alt="Logo" class="w-24 h-24 mx-auto mb-6 drop-shadow-2xl object-contain">
                <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">Pioneer Hospital</h1>
                <p class="text-blue-600 font-bold text-xs uppercase tracking-widest mt-2">Administrative Access</p>
            </div>
            <form id="loginForm" class="space-y-5" autocomplete="off">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 ml-2 uppercase">Username</label>
                    <input type="text" id="user" placeholder="Enter Admin ID" required class="input-field" autocomplete="off">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 ml-2 uppercase">Security Pin</label>
                    <input type="password" id="pin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required class="input-field" autocomplete="new-password">
                </div>
                <button type="submit" id="loginBtn" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl hover:bg-blue-600 shadow-xl transition-all active:scale-95 mt-4">
                    AUTHENTICATE SYSTEM
                </button>
            </form>
        </div>
    </div>

    <div id="adminPanel" class="flex flex-col lg:flex-row min-h-screen p-4 lg:p-8 gap-8">
        
        <aside class="w-full lg:w-80 glass rounded-[35px] p-6 lg:p-8 flex flex-col shadow-2xl">
            <div class="flex items-center justify-between mb-8 lg:mb-12">
                <div class="flex items-center gap-3">
                    <img src="https://i.ibb.co/Ndrx7JS9/pionnerlogo.webp" class="w-10 h-10 object-contain">
                    <div class="text-xl font-extrabold text-slate-800">PIONEER <span class="text-blue-600">ADMIN</span></div>
                </div>
            </div>

            <nav class="space-y-3 flex-1">
                <div onclick="showSection('registration')" class="nav-item p-4 bg-blue-600 text-white rounded-2xl font-bold flex items-center gap-3 cursor-pointer transition-all shadow-lg shadow-blue-200">
                    <span>‚ûï</span> Register Doctor
                </div>
                <div onclick="fetchDatabase()" class="nav-item p-4 text-slate-500 hover:bg-white rounded-2xl transition cursor-pointer flex items-center gap-3 font-semibold">
                    <span>üìã</span> Doctor Database
                </div>
            </nav>

            <button onclick="logout()" class="mt-8 p-4 bg-red-50 text-red-500 rounded-2xl font-bold hover:bg-red-500 hover:text-white transition flex items-center justify-center gap-2">
                Sign Out System
            </button>
        </aside>

        <main class="flex-1 max-w-6xl relative">
            <div class="absolute -top-2 right-4 text-right hidden md:block">
                <div id="dashDate" class="text-[10px] font-bold text-blue-600 uppercase tracking-widest mb-1"></div>
                <div id="dashClock" class="text-2xl font-black text-slate-800 tracking-tighter"></div>
            </div>

            <div id="registrationSection" class="glass rounded-[45px] p-6 md:p-12 shadow-2xl relative mt-10 md:mt-0">
                <div id="loadingOverlay" class="absolute inset-0 bg-white/60 backdrop-blur-md z-50 flex items-center justify-center hidden rounded-[45px]">
                    <div class="flex flex-col items-center gap-4 w-64">
                        <div class="spinner"></div>
                        <p class="text-xs font-black text-slate-800 tracking-tighter uppercase">Processing Data</p>
                        <div class="progress-container" id="progressBarContainer"><div class="progress-fill" id="progressBar"></div></div>
                    </div>
                </div>

                <header class="mb-8 flex flex-col md:flex-row justify-between md:items-center gap-4">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-extrabold text-slate-800 tracking-tight" id="formTitle">Doctor Registration</h2>
                        <p class="text-slate-500 text-sm mt-1">Official credentials and institutional data.</p>
                    </div>
                    <div id="docIdBadge" class="hidden">
                        <span class="bg-blue-600 text-white px-5 py-2.5 rounded-2xl text-[11px] font-black tracking-widest shadow-lg">ID: <span id="displayId"></span></span>
                    </div>
                </header>

                <form id="doctorForm" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-5">
                    <input type="hidden" name="id" id="hiddenId">
                    
                    <div class="space-y-2">
                        <label class="text-[11px] font-bold text-slate-400 tracking-widest uppercase">Doctor Full Name</label>
                        <input type="text" name="name" required class="input-field" placeholder="DR. JOHN DOE" oninput="this.value = this.value.toUpperCase()">
                    </div>

                    <div class="space-y-2">
                        <label class="text-[11px] font-bold text-slate-400 tracking-widest uppercase">Specialty / Role</label>
                        <input type="text" name="specialty" required class="input-field" placeholder="CONSULTANT" oninput="this.value = this.value.toUpperCase()">
                    </div>

                    <div class="md:col-span-2 space-y-3">
                        <label class="text-[11px] font-bold text-slate-400 tracking-widest uppercase">Department Category</label>
                        <input type="hidden" name="category" id="selectedCategory" required>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2" id="catGrid"></div>
                    </div>

                    <div class="space-y-2">
                        <label class="text-[11px] font-bold text-slate-400 tracking-widest uppercase">Medical College / School</label>
                        <input type="text" name="collage" required class="input-field" placeholder="DMC / SSMC / ETC" oninput="this.value = this.value.toUpperCase()">
                    </div>

                    <div class="space-y-2">
                        <label class="text-[11px] font-bold text-slate-400 tracking-widest uppercase">Qualification / Meta</label>
                        <input type="text" name="degree" class="input-field" placeholder="MBBS, MD (USA)" oninput="this.value = this.value.toUpperCase()">
                    </div>

                    <div class="space-y-2">
                        <label class="text-[11px] font-bold text-slate-400 tracking-widest uppercase">Official Phone</label>
                        <input type="tel" name="phone" required pattern="[0-9]{11}" minlength="11" maxlength="11" class="input-field" placeholder="01XXXXXXXXX">
                    </div>

                    <div class="space-y-2">
                        <label class="text-[11px] font-bold text-slate-400 tracking-widest uppercase">Practice Days</label>
                        <input type="text" name="days" class="input-field" placeholder="SAT - THU" oninput="this.value = this.value.toUpperCase()">
                    </div>

                    <div class="space-y-2">
                        <label class="text-[11px] font-bold text-slate-400 tracking-widest uppercase">Visiting Hours</label>
                        <input type="text" name="timing" class="input-field" placeholder="05:00 PM - 09:00 PM" oninput="this.value = this.value.toUpperCase()">
                    </div>

                    <div class="space-y-2">
                        <label class="text-[11px] font-bold text-slate-400 tracking-widest uppercase">Room / Chamber</label>
                        <input type="text" name="room" class="input-field" placeholder="405" oninput="this.value = this.value.toUpperCase()">
                    </div>

                    <div class="space-y-2">
                        <label class="text-[11px] font-bold text-slate-400 tracking-widest uppercase">Consultation Fee</label>
                        <input type="number" name="fee" class="input-field" placeholder="1000">
                    </div>

                    <div class="space-y-2">
                        <label class="text-[11px] font-bold text-slate-400 tracking-widest uppercase">Availability Status</label>
                        <select name="status" class="input-field cursor-pointer font-bold">
                            <option value="AVAILABLE">üü¢ AVAILABLE</option>
                            <option value="NOT AVAILABLE">üî¥ NOT AVAILABLE</option>
                        </select>
                    </div>

                    <div class="md:col-span-2 pt-4">
                        <button type="submit" id="saveBtn" class="w-full bg-slate-900 text-white font-bold py-5 rounded-[22px] shadow-2xl hover:bg-blue-600 transition-all tracking-widest active:scale-95">
                            SAVE TO SECURE CLOUD
                        </button>
                    </div>
                </form>
            </div>

            <div id="databaseSection" class="glass rounded-[45px] p-6 md:p-12 shadow-2xl hidden mt-10 md:mt-0">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl md:text-3xl font-extrabold text-slate-800">Doctor Database</h2>
                    <button onclick="fetchDatabase()" class="text-blue-600 font-bold text-sm">üîÑ Refresh</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left min-w-[600px]">
                        <thead>
                            <tr class="text-[10px] text-slate-400 tracking-widest border-b border-slate-200">
                                <th class="pb-4">UNIQUE CODE</th>
                                <th class="pb-4">NAME & COLLEGE</th>
                                <th class="pb-4">SPECIALTY</th>
                                <th class="pb-4">PHONE</th>
                                <th class="pb-4 text-right">ACTION</th>
                            </tr>
                        </thead>
                        <tbody id="dbTableBody" class="text-sm font-semibold text-slate-700"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="successToast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-8 py-4 rounded-full shadow-2xl flex items-center gap-3 opacity-0 pointer-events-none transition-all duration-500 z-[2000]">
        <span class="bg-green-500 rounded-full p-1 text-[10px]">‚úî</span>
        <span id="toastMsg">Operation Successful</span>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw5dltboD5KqxrzhLaKeyUySnnfyxWwqJiw4cZ0dbNjzj-mt1z6D7z5CmRLPdN2XCRVnw/exec";
        const CATEGORIES = ["MEDICINE", "CARDIOLOGY", "NEUROLOGY", "GASTROENTEROLOGY", "GYNECOLOGY", "PEDIATRICS", "UROLOGY", "GENERAL SURGERY", "ORTHOPEDICS", "ENT", "DIABETOLOGY", "PSYCHIATRY", "DERMATOLOGY", "DENTAL", "EYE / OPTIC"];

        // 1. TIMEOUT LOGIC (10 Minutes)
        let idleTimer;
        const IDLE_LIMIT = 10 * 60 * 1000; // 10 minutes in ms

        function resetTimer() {
            clearTimeout(idleTimer);
            if (sessionStorage.getItem('auth') === 'true') {
                idleTimer = setTimeout(logout, IDLE_LIMIT);
            }
        }

        // Listen for user activity
        ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(evt => {
            window.addEventListener(evt, resetTimer);
        });

        // 2. LIVE CLOCK
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour12: true, hour: '2-digit', minute: '2-digit' });
            const dateStr = now.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
            
            const clockEl = document.getElementById('dashClock');
            const dateEl = document.getElementById('dashDate');
            if(clockEl) clockEl.innerText = timeStr;
            if(dateEl) dateEl.innerText = dateStr;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // UI Setup
        const catGrid = document.getElementById('catGrid');
        CATEGORIES.forEach(cat => {
            const div = document.createElement('div');
            div.className = 'cat-chip';
            div.innerText = cat;
            div.onclick = () => {
                document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('selected'));
                div.classList.add('selected');
                document.getElementById('selectedCategory').value = cat;
                resetTimer();
            };
            catGrid.appendChild(div);
        });

        function showSection(sec) {
            document.getElementById('registrationSection').classList.toggle('hidden', sec !== 'registration');
            document.getElementById('databaseSection').classList.toggle('hidden', sec !== 'database');
            resetTimer();
        }

        // Login (No "Remember Me" allowed as requested)
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('loginBtn');
            btn.innerText = "AUTHENTICATING...";
            btn.disabled = true;

            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'verifyLogin',
                        user: document.getElementById('user').value,
                        pin: document.getElementById('pin').value
                    })
                });
                const data = await res.json();
                if (data.success) {
                    sessionStorage.setItem('auth', 'true');
                    location.reload();
                } else {
                    alert("Access Denied: Invalid Credentials");
                    btn.innerText = "AUTHENTICATE SYSTEM";
                    btn.disabled = false;
                }
            } catch (err) { alert("Server Error"); btn.disabled = false; }
        });

        if (sessionStorage.getItem('auth') === 'true') {
            document.getElementById('loginGate').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'flex';
            resetTimer();
        }

        async function fetchDatabase() {
            showSection('database');
            const tbody = document.getElementById('dbTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="py-10 text-center"><div class="flex justify-center"><div class="spinner"></div></div></td></tr>';

            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getDoctors' }) });
                const response = await res.json();

                if (response.success && response.data) {
                    tbody.innerHTML = '';
                    response.data.forEach(doc => {
                        const tr = document.createElement('tr');
                        tr.className = "border-b border-slate-100 hover:bg-white/50 transition";
                        tr.innerHTML = `
                            <td class="py-4 font-mono text-xs text-blue-600 font-bold">${doc.id}</td>
                            <td class="py-4">
                                <div class="font-bold text-slate-800">${doc.name}</div>
                                <div class="text-[9px] text-blue-500 font-bold uppercase">${doc.collage || 'N/A'}</div>
                            </td>
                            <td class="py-4 text-xs font-bold text-slate-600">${doc.specialty}</td>
                            <td class="py-4 text-slate-500 font-mono text-xs">${doc.phone}</td>
                            <td class="py-4 text-right flex justify-end gap-2">
                                <button onclick='editDoc(${JSON.stringify(doc)})' class="bg-slate-900 text-white px-3 py-1.5 rounded-lg text-[10px] font-black hover:bg-blue-600 transition active:scale-90">EDIT</button>
                                <button onclick='deleteDoc("${doc.id}")' class="bg-red-500 text-white px-3 py-1.5 rounded-lg text-[10px] font-black hover:bg-red-700 transition active:scale-90">DEL</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            } catch (e) { tbody.innerHTML = '<tr><td colspan="5" class="py-10 text-center text-red-500">Connection Failed.</td></tr>'; }
        }

        function editDoc(doc) {
            showSection('registration');
            document.getElementById('formTitle').innerText = "Update Doctor Record";
            document.getElementById('saveBtn').innerText = "UPDATE CLOUD RECORD";
            document.getElementById('hiddenId').value = doc.id;
            document.getElementById('displayId').innerText = doc.id;
            document.getElementById('docIdBadge').classList.remove('hidden');

            const form = document.getElementById('doctorForm');
            // Populate standard fields
            for (let key in doc) { if (form[key]) form[key].value = doc[key]; }

            // Handle Category UI
            document.querySelectorAll('.cat-chip').forEach(chip => {
                chip.classList.toggle('selected', chip.innerText === doc.category);
                if (chip.innerText === doc.category) document.getElementById('selectedCategory').value = doc.category;
            });
        }

        let deleteIdStore = null;
        function deleteDoc(id) {
            deleteIdStore = id;
            const modal = document.getElementById('deleteModal');
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); }, 10);
            document.getElementById('confirmDeleteBtn').onclick = executeDelete;
        }

        function closeDeleteModal() {
            const modal = document.getElementById('deleteModal');
            modal.classList.add('opacity-0');
            setTimeout(() => { modal.classList.add('hidden'); deleteIdStore = null; }, 300);
        }

        async function executeDelete() {
            if (!deleteIdStore) return;
            const id = deleteIdStore;
            closeDeleteModal();
            toggleLoading(true);
            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'deleteDoctor', id: id }) });
                const result = await res.json();
                if (result.success) { showToast("Deleted"); fetchDatabase(); }
            } catch (err) { alert("Error"); } finally { toggleLoading(false); }
        }

        document.getElementById('doctorForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            if (!document.getElementById('selectedCategory').value) return alert("Select Category");
            toggleLoading(true);
            const payload = Object.fromEntries(new FormData(this));
            payload.action = payload.id ? "updateDoctor" : "addDoctor";

            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                const result = await res.json();
                showToast(result.message || "Saved!");
                setTimeout(() => location.reload(), 1500);
            } catch (err) { alert("Save Failed"); toggleLoading(false); }
        });

        function toggleLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
            document.getElementById('progressBarContainer').style.display = show ? 'block' : 'none';
            if(show) document.getElementById('progressBar').style.width = "70%";
        }

        function showToast(msg) {
            const toast = document.getElementById('successToast');
            document.getElementById('toastMsg').innerText = msg;
            toast.style.opacity = "1";
            toast.style.bottom = "40px";
            setTimeout(() => { toast.style.opacity = "0"; toast.style.bottom = "10px"; }, 3000);
        }

        function logout() { sessionStorage.removeItem('auth'); location.reload(); }
        // Prevent accidental menu/inspect
        document.addEventListener('contextmenu', e => e.preventDefault());
    </script>
</body>
</html>